---
title: "Home rang and resource selection."
author: "Jeff Grayum"
date: '2023-01-09'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading libraries.
```{r}
library(tidyverse)
library(scales)
library(ggthemes)
library(readxl)
library(janitor)
library(lubridate)
library(adehabitatHR)
library(magrittr)
library(gitcreds)
library(sf)
library(raster)
library(RColorBrewer)
```

Importing winter 2021/22 data, cleaning, filtering (30+ obs), and creating Spatial Point Data Frame.
```{r}
#Importing data, making names snake_case
winter_2021_22_locs <- read_excel("/Users/jeffgrayum/Documents/BobwhiteData/BobwhiteData 2/All_Winter_Locs_Oct_2021_Traps.xlsx") %>%
  clean_names()

winter_2021_22_locs %>%
  view()

#Making list of birds with 30+ observations
samp_list <- winter_2021_22_locs %>%
  group_by(band_numb) %>%
  summarize(n = n()) %>%
  arrange(n) %>%
  filter(n > 30) %>%
  dplyr::select(band_numb) %>%
  extract2(1) %>%
  as.character() 

#Filtering spreadsheet; only including birds from samp_list --> "SampleSize_winter_locs" 
SS_winter_2021_22_locs <- winter_2021_22_locs %>%
  filter(band_numb %in% samp_list) %>%
  droplevels()

#Exporting as .csv, just in case I need it later.
write.csv(SS_winter_locs,"/Users/jeffgrayum/Downloads/SS_winter_locs_2021_22.csv", row.names = FALSE)

#Verifying only birds with 30+ obs are included in data frame
SS_winter_2021_22_locs %>%
  count(band_numb)

#Definining projection for Spatial Points Data Frame (SPDF) as NAD 1983 16N 
prj <- '+init=epsg:26916'
CRS("+init=epsg:26916")

#Create the SPDF --> This let's R know we're dealing with spatial data, and associates coordinates with all obs in the row. My coords are stored in columns "easting" and "northing".
SS_winter_2021_22_locs_SPDF <- SpatialPointsDataFrame(coordinates(cbind(SS_winter_2021_22_locs$easting, SS_winter_2021_22_locs$northing)), data = SS_winter_2021_22_locs, proj4string = CRS(prj))
```

Importing shapefiles and raster layers of study site. Looking at Winter 2021/22 locations.
```{r}
#Shapefile of study site.
SF_StudySite <- st_read("/Users/jeffgrayum/Downloads/2021_quail_prj", crs = "+init=epsg:26916")

#Verifying datum
crs(SF_StudySite)

#Plotting SPDF over Shapefile. These can be plotted in reverse order for view of entire study site.
plot(SS_winter_locs__2021_22_SPDF)
plot(SF_StudySite, add = TRUE)



#Importing raster layer of study site. Includes land cover layer for RSF.
Raster_StudySite <- raster("/Users/jeffgrayum/Documents/qGIS/LCovRaster.tiff", crs = "+init=epsg:26916")

#Verifying datum
crs(Raster_StudySite)

#Plotting SPDF over raster layer. Again, these can be plotted in reverse order for view of entire study site.
plot(SS_winter_2021_22_locs_SPDF)
plot(Raster_StudySite, alpha = 0.5, add = TRUE)
```

Evaluating Winter 2021/22 minimum convex polygon (MCP) home ranges for each bobwhite.
```{r}
#We'll plot a MCP HR for each bird, making a home range for each band number (stored in column 7) [, 7] 
#Verifying band number is actually in column 7.
SS_winter_2021_22_locs_SPDF[, 7]

#Creating MCP for each bobwhite.
mcp_hr_winter_2021_22 <- mcp((SS_winter_2021_22_locs_SPDF[, 7]))

#Plotting HR, adding observed locations, adding shapefile of study site.
plot(mcp_hr_winter_2021_22)
plot(SS_winter_2021_22_locs_SPDF, col = as.data.frame(SS_winter_2021_22_locs_SPDF)[,7], add = TRUE)
#Below, we can add Raster_StudySite or SF_StudySite
plot(SF_StudySite, add = TRUE, alpha = 0.5)

#Looking at size of home range (in hectares) for each bobwhite
as.data.frame(mcp_hr_winter_2021_22)

#Calculating home range size across levels/utilization distributions (i.e., 50%, 90%)
#First, we have to adjust plot margins (large plot)
par(mar = c(1, 1, 1, 1))
#Then, we can plot home range sizes for different Utilization Distributions
across_levels <- mcp.area(SS_winter_2021_22_locs_SPDF[,7])
```

Now, looking at percent of each land cover type within each bobwhite's MCP (availability).
Importhing spreadsheets (made with ArcGIS), cleaning names.
```{r}
#Importing sprreadsheet of landcover availability within MCP home range.
wint_mcp_percent_lcov <- read_excel("/Users/jeffgrayum/Downloads/WintMCP_Habitat_Percent.xlsx")

#Taking a quick look.
wint_mcp_percent_lcov %>%
  view()

#Shortening names of each land cover type. Changing column names.
wint_mcp_percent_lcov_clean <- wint_mcp_percent_lcov %>% 
  mutate(HABITAT = ifelse(HABITAT == "AGRICULTURAL", "AG", 
                         ifelse(HABITAT == "WILDLIFE FOOD PLOT", "WFP", 
                                ifelse(HABITAT == "HARDWOOD", "HW", 
                                       ifelse(HABITAT == "PINE/HARDWOOD", "P_H", 
                                              ifelse(HABITAT == "HARDWOOD/PINE FOREST", "H_P", 
                                                     ifelse(HABITAT == "WETLAND", "WL", 
                                                            ifelse(HABITAT == "SHRUB/SCRUB", "S_S", 
                                                                   ifelse(HABITAT == "URBAN/MOWED", "MOW", 
                                                                          ifelse(HABITAT == "PINE PLANTATION", "PP", 
                                                                                 ifelse(HABITAT == "NATURAL PINE", "NP", HABITAT))))))))))) %>%
    rename(LCOV = HABITAT,
           HR_Size = Hectares,
           ha_of_lcov = Hab_Hectar) %>%
  clean_names()

#Does it look better? I believe so.
wint_mcp_percent_lcov_clean %>% 
  view()

#Importing spreadsheet of landcover type of recorded locations (selection)
wint_selection <- read_excel("/Users/jeffgrayum/Downloads/AllWinterLocs_ObsHabitat.xlsx") %>%
  view()

#Cleaning names, so they match availability spreadsheet.
wint_selection_clean <- wint_selection %>%
   mutate(HABITAT = ifelse(HABITAT == "AGRICULTURAL", "AG", 
                         ifelse(HABITAT == "WILDLIFE FOOD PLOT", "WFP", 
                                ifelse(HABITAT == "HARDWOOD", "HW", 
                                       ifelse(HABITAT == "PINE/HARDWOOD", "P_H", 
                                              ifelse(HABITAT == "HARDWOOD/PINE FOREST", "H_P", 
                                                     ifelse(HABITAT == "WETLAND", "WL", 
                                                            ifelse(HABITAT == "SHRUB/SCRUB", "S_S", 
                                                                   ifelse(HABITAT == "URBAN/MOWED", "MOW", 
                                                                          ifelse(HABITAT == "PINE PLANTATION", "PP", 
                                                                                 ifelse(HABITAT == "NATURAL PINE", "NP", HABITAT))))))))))) %>%
    rename(LCOV = HABITAT) %>%
  clean_names()

#Does it match (It does)
wint_selection_clean %>%
  view()

percent_of_obs_in_lcov <- wint_selection_clean %>%
  count(band_numb, lcov) %>%
  group_by(band_numb) %>%
  mutate(percent_observations = 100 * n / sum(n)) %>%
  view()

#Tryng to combine both spreadsheets, so we have percent availability and percent recorded obs together.
wint_avail_and_selection <- merge(wint_mcp_percent_lcov_clean, percent_of_obs_in_lcov, by = c("band_numb", "lcov"), all.x = TRUE) %>%
  view()

#Making this look better.
wint_avail_and_selection <- wint_avail_and_selection %>%
  rename(percent_lcov_avail = percent_hab,
         n_obs = n) 

  
#Filling NAs
  wint_avail_and_selection  <- wint_avail_and_selection %>%
    mutate(n_obs = replace_na(n_obs, 0),
           percent_observations = replace_na(percent_observations, 0))
  
           
```

Summarizing some date from winter 2021/22 land cover availability, some exploratory analysis.
```{r}
#Creating a spreadsheet of home range sizes for each bobwhite. Awkward but effective method.
hr_size_ha <- wint_mcp_percent_lcov_clean %>%
  group_by(band_numb) %>%
  summarize(hr_size_ha = mean(hr_size)) %>%
  view()

#Boxplot of hr sizes
hr_size_ha %>%
  ggplot(aes(x = "", y = hr_size_ha)) +
  geom_boxplot() +
  theme_minimal() +
  labs(x = "",
       y = "Home range size (ha)",
       title = "MCP home range sizes (ha) of NOBO at The Jones Center ")

#5 number summary of home range sizes.
summary(hr_size_ha$hr_size_ha)

#Let's look at availability of of each land cover type for bobwhite with relative small hr
#Filtering for NOBO in first quartile.
first_quartile <- wint_avail_and_selection %>%
  filter(hr_size <= 6.724)

#Bar chart of availability.
first_quartile %>%
  mutate(lcov = fct_relevel(lcov, c("MOW", "AG", "WFP", "S_S", "PP", "NP", "P_H", "H_P", "HW"))) %>%
  ggplot(aes(x = lcov, y = percent_lcov_avail/100, fill = lcov)) +
  geom_col() +
  geom_point(mapping = aes(x = lcov, y = percent_observations/100), shape = 3) +
  scale_y_continuous(labels = percent) +
  labs(x = "Land cover", 
       y = "Percent of available/selected land cover",
       title = "Available vs selected landcover for bobwhite with small home ranges",
       subtitle = "Columns show availability, plus signs show use") +
  theme_minimal() +
  scale_fill_manual(values = c("AG" = "#f3f587","WFP" = "#DDA0DD", "HW" = "#523232","P_H" = "#4B5320", "H_P" = "#8B5A2B", "S_S" = "#808080","MOW" = "#000000","PP" = "#0e4726","NP" = "#15994c")) +
  facet_wrap(~band_numb)

#Looking at availability for mid-sized HR.
second_quartile <- wint_avail_and_selection %>%
  filter(hr_size > 6.724,
         hr_size <=9.147 ) %>%
  view()

#Bar chart of small home ranges
second_quartile %>%
  mutate(lcov = fct_relevel(lcov, c("AG", "WFP", "S_S", "PP", "NP", "P_H", "H_P", "HW"))) %>%
  ggplot(aes(x = lcov, y = percent_lcov_avail/100, fill = lcov)) +
  geom_col() +
  geom_point(mapping = aes(x = lcov, y = percent_observations/100), shape = 3) +
  scale_y_continuous(labels = percent) +
  labs(x = "Land cover", 
       y = "Percent of available/selected land cover",
       title = "Available vs selected landcover for bobwhite with medium-small home ranges",
       subtitle = "Columns show availability, plus signs show use") +
  theme_minimal() +
  scale_fill_manual(values = c("AG" = "#f3f587","WFP" = "#DDA0DD", "HW" = "#523232","P_H" = "#4B5320", "H_P" = "#8B5A2B", "S_S" = "#808080", "PP" = "#0e4726","NP" = "#15994c")) +
  facet_wrap(~band_numb) 

#Looking at availability for large home ranges
third_quartile <- wint_avail_and_selection %>%
  filter(hr_size > 9.147, 
         hr_size <= 13.326) %>%
  view()

third_quartile %>%
    mutate(lcov = fct_relevel(lcov, c("MOW", "AG", "WFP", "S_S", "PP", "NP", "P_H", "H_P", "HW"))) %>%
  ggplot(aes(x = lcov, y = percent_lcov_avail/100, fill = lcov)) +
  geom_col() +
  geom_point(mapping = aes(x = lcov, y = percent_observations/100), shape = 3) +
  scale_y_continuous(labels = percent) +
  labs(x = "Land cover", 
       y = "Percent of available/selected land cover",
       title = "Available vs selected landcover for bobwhite with med-large home ranges",
       subtitle = "Columns show availability, plus signs show use") +
  theme_minimal() +
  scale_fill_manual(values = c("AG" = "#f3f587","WFP" = "#DDA0DD", "HW" = "#523232","P_H" = "#4B5320", "H_P" = "#8B5A2B", "S_S" = "#808080","MOW" = "#000000","PP" = "#0e4726","NP" = "#15994c")) +
  facet_wrap(~band_numb)

fourth_quartile <- wint_avail_and_selection %>%
  filter(hr_size > 13.326) %>%
  view()

fourth_quartile %>%
    mutate(lcov = fct_relevel(lcov, c("MOW", "AG", "WFP", "S_S", "PP", "NP", "P_H", "H_P", "HW"))) %>%
  ggplot(aes(x = lcov, y = percent_lcov_avail/100, fill = lcov)) +
  geom_col() +
  geom_point(mapping = aes(x = lcov, y = percent_observations/100), shape = 3) +
  scale_y_continuous(labels = percent) +
  labs(x = "Land cover", 
       y = "Percent of available/selected land cover",
       title = "Available vs selected landcover for bobwhite with large home ranges",
       subtitle = "Columns show availability, plus signs show use") +
  theme_minimal() +
  scale_fill_manual(values = c("AG" = "#f3f587","WFP" = "#DDA0DD", "HW" = "#523232","P_H" = "#4B5320", "H_P" = "#8B5A2B", "S_S" = "#808080","MOW" = "#000000","PP" = "#0e4726","NP" = "#15994c")) +
  facet_wrap(~band_numb)

```


Creating kernel density estimates (KDEs) of Winter 2021/22 home ranges for each bobwhite.
```{r}
#Creating KDE HRs
kde_hr_winter_2021_22 <- kernelUD(SS_winter_2021_22_locs_SPDF[, 7])

#Side-by-side image of all bobwhite HRs. Kind of silly.
image(kde_hr_winter_2021_22)

#Mapping KDE home ranges onto study site at a 90% UD
kde_hr_ud <- plot(getverticeshr(kde_hr_winter_2021_22, percent = 90))

#We can add either Raster_StudySite or SF_StudySite below.
plot(Raster_StudySite, alpha = 0.5, add = TRUE)
plot(SS_winter_2021_22_locs_SPDF, add = TRUE)

#Looking at a data frame of KDE HR sizes across various utilization distributions (e.g, 50%, 90%)
kernel.area(kde_hr_winter_2021_22) %>%
  view()
```


Repeating the process with Summer 2022 locations.
Importing data, cleaning, filtering (30+ obs), creating Spatial Points Data Frame
```{r}
#Importing data, making names snake_case
summer_2022_locs <- read_excel("/Users/jeffgrayum/Documents/BobwhiteData/ALL_LOCS_SUMMER_2022.xlsx") %>%
  clean_names()

summer_2022_locs %>%
  view()

#Making list of birds with 30+ observations
samp_list_summer_2022 <- summer_2022_locs %>%
  group_by(band_numb) %>%
  summarize(n = n()) %>%
  arrange(n) %>%
  filter(n > 30) %>%
  dplyr::select(band_numb) %>%
  extract2(1) %>%
  as.character() 

#Filtering spreadsheet; only including birds from samp_list --> "SampleSize_winter_locs" 
SS_summer_2022_locs <- summer_2022_locs %>%
  filter(band_numb %in% samp_list_summer_2022) %>%
  droplevels()

#Exporting as .csv, just in case I need it later.
#write.csv(SS_summer_2022_locs,"/Users/jeffgrayum/Downloads/SS_summer_2022_locs.csv", row.names = FALSE)

#Verifying only birds with 30+ obs are included in data frame
SS_summer_2022_locs %>%
  count(band_numb, sort = TRUE) %>%
  view()

#Definining projection for Spatial Points Data Frame (SPDF) as NAD 1983 16N 
prj <- '+init=epsg:26916'
CRS("+init=epsg:26916")

#Create the SPDF --> This let's R know we're dealing with spatial data, and associates coordinates with all obs in the row. My coords are stored in columns "easting" and "northing".
SS_summer_2022_locs_SPDF <- SpatialPointsDataFrame(coordinates(cbind(SS_summer_2022_locs$easting, SS_summer_2022_locs$northing)), data = SS_summer_2022_locs, proj4string = CRS(prj))
```

Importing shapefiles and raster layers, looking at Summer 2022 locations.
```{r}
#Shapefile of study site.
SF_StudySite <- st_read("/Users/jeffgrayum/Downloads/2021_quail_prj", crs = "+init=epsg:26916")

#Verifying datum
crs(SF_StudySite)

#Plotting SPDF over Shapefile. These can be plotted in reverse order for view of entire study site.
plot(SS_summer_2022_locs_SPDF)
plot(SF_StudySite, add = TRUE)



#Importing raster layer of study site. Includes land cover layer for RSF.
Raster_StudySite <- raster("/Users/jeffgrayum/Documents/qGIS/LCovRaster.tiff", crs = "+init=epsg:26916")

#Verifying datum
crs(Raster_StudySite)

#Plotting SPDF over raster layer. Again, these can be plotted in reverse order for view of entire study site.
plot(SS_summer_2022_locs_SPDF)
plot(Raster_StudySite, alpha = 0.5, add = TRUE)
```

Evaluating Summer 2022 minimum convex polygon (MCP) home ranges for each bobwhite.
```{r}
#We'll plot a MCP HR for each bird, making a home range for each band number (stored in column 7) [, 7] 
#Verifying band number is actually in column 7.
SS_summer_2022_locs_SPDF[, 7]

#Creating MCP for each bobwhite.
mcp_hr_summer_2022 <- mcp((SS_summer_2022_locs_SPDF[, 7]))

#Plotting HR, adding observed locations, adding shapefile of study site.
plot(mcp_hr_summer_2022)
plot(SS_summer_2022_locs_SPDF, col = as.data.frame(SS_summer_2022_locs_SPDF)[,7], add = TRUE)
#Below, we can add Raster_StudySite or SF_StudySite
plot(SF_StudySite, add = TRUE, alpha = 0.5)

#Looking at size of home range (in hectares) for each bobwhite
as.data.frame(mcp_hr_summer_2022)

#Calculating home range size across levels/utilization distributions (i.e., 50%, 90%)
#First, we have to adjust plot margins (large plot)
par(mar = c(1, 1, 1, 1))
#Then, we can plot home range sizes for different Utilization Distributions
across_levels <- mcp.area(SS_summer_2022_locs_SPDF[,7])
```

Creating kernel density estimates (KDEs) of Summer 2022 home ranges for each bobwhite.
```{r}
#Creating KDE HRs
kde_hr_summer_2022 <- kernelUD(SS_summer_2022_locs_SPDF[, 7])

#Side-by-side image of all bobwhite HRs.
image(kde_hr_summer_2022)

#Mapping KDE home ranges onto study site at a 90% UD
kde_hr_ud <- plot(getverticeshr(kde_hr_summer_2022, percent = 90))

#We can add either Raster_StudySite or SF_StudySite below.
plot(SF_StudySite, add = TRUE)
plot(SS_summer_2022_locs_SPDF, add = TRUE)

#Looking at a data frame of KDE HR sizes across various utilization distributions (e.g, 50%, 90%)
kernel.area(kde_hr_summer_2022) %>%
  view()
```




